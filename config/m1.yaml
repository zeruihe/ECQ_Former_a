#m1.yaml M1阶段baseline参数

# 固定离线路径（你已规划的落盘目录）
models:
  llama_dir: /root/autodl-tmp/hf_models/TsinghuaC3I/Llama-3.1-8B-UltraMedical
  clip_dir: /root/autodl-tmp/hf_models/openai/clip-vit-large-patch14
  dinov2_dir: /root/autodl-tmp/hf_models/facebook/dinov2-large
  biomedclip_dir: /root/autodl-tmp/hf_models/microsoft/BiomedCLIP-PubMedBERT_256-vit_base_patch16_224

  # Encoder ablation switch: [clip], [clip, biomedclip], [clip, biomedclip, dinov2]
  enabled_encoders: [clip]
  auto_m_queries: true   # m_queries = 32 * len(enabled_encoders)

  # bridge config
  d_bridge: 768
  meq_layers: 12
  meq_heads: 12
  # m_queries: 96   # optional if auto_m_queries=false

data:
  # 你现有 data 模块需要的 sources 配置
  split: train
  return_pil: true
  pin_memory: true
  shuffle: true
  num_workers: 4
  batch_size: 1

  sources:
    - name: rocov2
      root: /root/autodl-tmp
      ann:
        train: /root/autodl-tmp/rocov2/caption_rocov2_train.json
        valid: /root/autodl-tmp/rocov2/caption_rocov2_val.json
        test:  /root/autodl-tmp/rocov2/caption_rocov2_test.json
      image_key: image
      text_key: caption
      id_key: image_id

    - name: mimic_cxr
      root: /root/autodl-tmp
      ann:
        train: /root/autodl-tmp/mimic_cxr/mimic_cxr_train.json
        valid: /root/autodl-tmp/mimic_cxr/mimic_cxr_val.json
        test:  /root/autodl-tmp/mimic_cxr/mimic_cxr_test.json
      image_key: image
      text_key: caption
      id_key: null

train:
  seed: 3407
  
  # Epoch-based training (recommended)
  # num_epochs takes priority over max_steps
  # Pretrain: typically 1-3 epochs
  num_epochs: 1
  # max_steps: 2000  # fallback if num_epochs is not set
  
  grad_accum: 8
  lr: 1.0e-4
  weight_decay: 0.01
  max_length: 256
  prompt_prefix: "Describe the medical image:\n"

  # precision
  bf16: true               # RTX5090 建议 true；若改 fp16，则 bf16=false 且 fp16=true
  fp16: false

  # logging / checkpoint
  log_every: 10
  save_every: 200
  keep_last_k: 3           # 仅保留最近 K 个 step checkpoint
  save_latest: true

  # resume
  auto_resume: true        # 若 out_dir/run_name/checkpoints/latest.pt 存在则自动续训
  resume_from: null        # 手动指定某个 ckpt 路径则优先

# 评估/推理时的解码参数（统一口径，方便不同阶段对比）
eval:
  max_new_tokens: 32
  num_beams: 1
  temperature: 0.7
  top_p: 0.95
  no_repeat_ngram_size: 3
  repetition_penalty: 1.15
  early_stopping: true

output:
  out_dir: /root/autodl-tmp/outputs
  run_name: m1_pertrain_clip

